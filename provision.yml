---
# Setup facts and populate them for the following plays
- name: "gather facts"
  import_playbook: playbooks/apollo-facts.yml
  tags:
    - always
    - facts
  
# If on AWS: fix login user (ubuntu)
- name: "AWS: Enable root access"
  import_playbook: playbooks/aws.yml
  tags:
    - provider_aws
  when: 
    - arc['infrastructure']['enabled']|bool
    - arc['infrastructure']['provider'] == "aws"

# Setup local space configuration (ssh config, docker context, readme)
- name: "setup space"
  import_playbook: playbooks/apollo-spaces.yml
  tags:
    - spaces
  when: not in_ci|bool

- name: "deploy"
  import_playbook: playbooks/deploy.yml
  tags:
    - deploy

# # Setup GitLab runner configuration
# - name: "@apollo-runner"
#   import_playbook: playbooks/apollo-gitlab-runner.yml
#   when: arc['gitlab']['runner']['enabled']|bool
#   tags:
#     - runner

# - name: "@apollo-recap"
#   import_playbook: playbooks/apollo-recap.yml
#   tags:
#     - recap

# Setup federation (WIP)
# - name: "federation"
#   import_playbook: playbooks/apollo-federation.yml
#   tags:
#     - federation
#   when: arc['federation']['enabled']|bool

# Setup controlplane configuration (logging, metrics, visualization, ...)

# Setup backplane configuration (portainer, proxy, ...)
# - name: "@apollo-backplane"
#   import_playbook: playbooks/apollo-backplane.yml
#   when: arc['caas']['enabled']|bool
#   tags:
#     - backplane

# Setup app configuration (gitlab, minio, ...)
# - name: "@apollo-apps"
#   import_playbook: playbooks/apollo-apps.yml
#   when: apollo_apps|length > 0
#   tags:
#     - apps