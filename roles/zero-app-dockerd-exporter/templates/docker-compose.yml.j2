version: '3.7'

services:
  dockerd-exporter:
    image: {{ images.dockerd_exporter }}
    environment:
      IN: "{{ dockerd_in }}"
      OUT: "{{ dockerd_out }}"
    networks: 
      - monitoring
    healthcheck:
      test: "/bin/wget -q -Y off http://localhost:9093/metrics -O /dev/null > /dev/null 2>&1"
      interval: 25s
      timeout: 3s
      start_period: 30s
    deploy:
      mode: global
      update_config:
        parallelism: 1
        delay: 60s
        monitor: 30s
        order: stop-first
        failure_action: rollback
      restart_policy:
        condition: on-failure
      placement:
        constraints: 
        - node.platform.os == linux

networks:
  monitoring:
    driver: overlay
    external: true