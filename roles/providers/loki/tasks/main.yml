---
- name: "Provision {{ app_name }}"
  block:

    - name: Create app group
      group:
        name: "{{ app_name }}"
        state: present

    - name: Create app user
      user:
        name: "{{ app_name }}"
        comment: "apollo-app-{{ app_name }}"
        group: "{{ app_name }}"

    - name: Creating app directory
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ app_name }}"
        group: "{{ app_name }}"

    - name: Creating storage directory
      file:
        path: "{{ arc['data']['volumes_dir'] }}/{{ app_name }}"
        state: directory
        mode: '0755'
        owner: "{{ app_name }}"
        group: "{{ app_name }}"

    - name: Creating config directories
      file:
        path: "{{ app_dir }}/{{ config_dir.path }}"
        state: directory
        mode: '{{ config_dir.mode }}'
        owner: "{{ app_name }}"
        group: "{{ app_name }}"
      with_filetree:
        - "files/"
      when: config_dir.state == 'directory'
      loop_control:
        label: "{{ config_dir.path }}"
        loop_var: config_dir

    - name: Creating config files
      copy:
        src: "{{ config_file.src }}"
        dest: "{{ app_dir }}/{{ config_file.path }}"
        mode: "{{ config_file.mode }}"
        owner: "{{ app_name }}"
        group: "{{ app_name }}"
      with_filetree:
        - "files/"
      when: config_file.state == 'file'
      loop_control:
        label: "{{ config_file.path }}"
        loop_var: config_file

    - name: "Creating {{ app_name }} config"
      template:
        src: templates/loki-config.yml.j2
        dest: "{{ app_dir }}/loki-config.yml"
        owner: "{{ app_name }}"
        group: "{{ app_name }}"
        mode: '0644'
      notify: restart loki

    - name: "Download {{ app_name }} binary"
      become: false
      get_url:
        url: "https://github.com/grafana/loki/releases/download/v{{ loki_version }}/loki-linux-amd64.zip"
        dest: "/tmp/loki-v{{ loki_version }}.zip"
      register: _download_binary
      until: _download_binary is succeeded
      retries: 5
      delay: 2
      check_mode: false

    - name: "Unpack {{ app_name }} binary"
      become: false
      unarchive:
        remote_src: True
        src: "/tmp/loki-v{{ loki_version }}.zip"
        dest: "/tmp"
        creates: "/tmp/loki-linux-amd64"
      check_mode: false

    - name: "Propagate {{ app_name }} binary"
      copy:
        src: "/tmp/loki-linux-amd64"
        dest: "{{ _loki_binary_install_dir }}/loki"
        mode: 0755
        owner: root
        group: root
        remote_src: True
      notify: restart loki
      when: not ansible_check_mode

    - name: "Copy {{ app_name }} systemd service file"
      template:
        src: templates/loki.service.j2
        dest: /etc/systemd/system/loki.service
        owner: root
        group: root
        mode: 0644
      notify: restart loki

    - name: Make sure service is started
      service:
        name: loki
        state: started
        enabled: true
  when: 
    - ansible_hostname == "manager-0"