---
# tasks file for zero-app-traefik
- name: Provision Traefik
  block:
    - name: Copy Stack-File
      template:
        src: templates/docker-compose.yml.j2
        dest: /tmp/zero-app-traefik.yml
        owner: root
        group: root
        mode: '0644'
    
    - name: Provision Traefik
      docker_stack:
        state: present
        name: traefik
        prune: yes
        with_registry_auth: yes
        compose:
          - /tmp/zero-app-traefik.yml
      register: traefik_provision
      tags:
          - traefik

    - name: Debug Traefik
      debug:
        var: traefik_provision
        verbosity: 1
      tags:
          - traefik
      when: traefik_provision.changed

    - name: "Wait for proxy.{{ base_domain }} to become ready"
      uri:
        url: "https://proxy.{{ base_domain }}"
        method: GET
        status_code: 200
        user: "{{admin_user}}"
        password: "{{admin_password}}"
        validate_certs: no
      register: _result
      until: _result.status == 200
      retries: 30 # retry X times  
      delay: 5 # pause for X sec b/w each call 
      tags:
        - traefik

    - name: Get Container ID
      shell: docker ps -f name=traefik_traefik --format "{{ '{{' }}.ID{{ '}}'}}"
      register: traefik_app

    - name: Debug
      debug:
        var: traefik_app

    - name: add container to inventory
      add_host:
        name: "{{ traefik_app.stdout }}"
        ansible_connection: docker
      changed_when: false
      failed_when: traefik_app.stdout == ""        

    # - name: Remove Stack File
    #   file:
    #     path: /tmp/zero-stacks-nextcloud.yml
    #     state: absent
  rescue:
    - name: Teardown Nextcloud
      docker_stack:
          absent_retries: 5
          absent_retries_interval: 10
          state: absent
          name: nextcloud
      register: nextcloud_teardown
      tags:
          - nextcloud 
    # - name: Remove Stack File
    #   file:
    #     path: /tmp/zero-app-traefik.yml
    #     state: absent
